From stable+bounces-119650-greg=kroah.com@vger.kernel.org Wed Feb 26 10:40:11 2025
From: "Ricardo Cañuelo Navarro" <rcn@igalia.com>
Date: Wed, 26 Feb 2025 10:39:07 +0100
Subject: tun: Add missing bpf_net_ctx_clear() in do_xdp_generic()
To: stable@vger.kernel.org,  Sebastian Andrzej Siewior <bigeasy@linutronix.de>
Cc: revest@google.com, kernel-dev@igalia.com,  Jeongjun Park <aha310510@gmail.com>,  syzbot+44623300f057a28baf1e@syzkaller.appspotmail.com,  Jason Wang <jasowang@redhat.com>, Willem de Bruijn <willemb@google.com>,  syzbot+3c2b6d5d4bec3b904933@syzkaller.appspotmail.com,  syzbot+707d98c8649695eaf329@syzkaller.appspotmail.com,  syzbot+c226757eb784a9da3e8b@syzkaller.appspotmail.com,  syzbot+61a1cfc2b6632363d319@syzkaller.appspotmail.com,  syzbot+709e4c85c904bcd62735@syzkaller.appspotmail.com,  "David S. Miller" <davem@davemloft.net>
Message-ID: <20250226-20250204-kasan-slab-use-after-free-read-in-dev_map_enqueue__submit-v3-3-360efec441ba@igalia.com>

From: Jeongjun Park <aha310510@gmail.com>

[ Upstream commit 9da49aa80d686582bc3a027112a30484c9be6b6e ]

There are cases where do_xdp_generic returns bpf_net_context without
clearing it. This causes various memory corruptions, so the missing
bpf_net_ctx_clear must be added.

Reported-by: syzbot+44623300f057a28baf1e@syzkaller.appspotmail.com
Fixes: fecef4cd42c6 ("tun: Assign missing bpf_net_context.")
Signed-off-by: Jeongjun Park <aha310510@gmail.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reported-by: syzbot+3c2b6d5d4bec3b904933@syzkaller.appspotmail.com
Reported-by: syzbot+707d98c8649695eaf329@syzkaller.appspotmail.com
Reported-by: syzbot+c226757eb784a9da3e8b@syzkaller.appspotmail.com
Reported-by: syzbot+61a1cfc2b6632363d319@syzkaller.appspotmail.com
Reported-by: syzbot+709e4c85c904bcd62735@syzkaller.appspotmail.com
Signed-off-by: David S. Miller <davem@davemloft.net>
[rcn: trivial backport edit to adapt the patch context.]
Signed-off-by: Ricardo CaÃ±uelo Navarro <rcn@igalia.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
---
 net/core/dev.c |    1 +
 1 file changed, 1 insertion(+)

--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -5106,6 +5106,7 @@ int do_xdp_generic(struct bpf_prog *xdp_
 			bpf_net_ctx_clear(bpf_net_ctx);
 			return XDP_DROP;
 		}
+		bpf_net_ctx_clear(bpf_net_ctx);
 	}
 	return XDP_PASS;
 out_redir:
